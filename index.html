<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mermaid Diagram Viewer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.6.1/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dom-to-image/2.6.0/dom-to-image.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --accent-color: #3b82f6;
            --accent-hover: #2563eb;
            --error-color: #ef4444;
            --success-color: #10b981;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --accent-color: #60a5fa;
            --accent-hover: #3b82f6;
        }

        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            overflow: hidden;
        }

        .container {
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .toolbar {
            background-color: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            min-height: 48px;
        }

        .toolbar-group {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 0 8px;
            border-right: 1px solid var(--border-color);
        }

        .toolbar-group:last-child {
            border-right: none;
        }

        .btn {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s ease;
        }

        .btn:hover {
            background-color: var(--accent-color);
            color: white;
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .btn-primary:hover {
            background-color: var(--accent-hover);
        }

        .select {
            background-color: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            min-width: 120px;
        }

        .main-content {
            flex: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }

        .editor-pane {
            width: 50%;
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .editor-header {
            background-color: var(--bg-secondary);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-content {
            flex: 1;
            position: relative;
        }

        #editor {
            width: 100%;
            height: 100%;
        }

        .preview-pane {
            width: 50%;
            background-color: var(--bg-primary);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .preview-header {
            background-color: var(--bg-secondary);
            padding: 8px 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .preview-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: var(--bg-primary);
        }

        #preview {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .error-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--error-color);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            padding: 20px;
            text-align: center;
            z-index: 10;
        }

        .resizer {
            width: 4px;
            background-color: var(--border-color);
            cursor: col-resize;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            z-index: 20;
            transition: background-color 0.2s ease;
        }

        .resizer:hover {
            background-color: var(--accent-color);
        }

        .fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
            background-color: var(--bg-primary) !important;
        }

        .zoom-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: none;
            gap: 4px;
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 4px;
            z-index: 10;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border: none;
            background-color: transparent;
            color: var(--text-primary);
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
        }

        .zoom-btn:hover {
            background-color: var(--accent-color);
            color: white;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-secondary);
        }

        .spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top: 2px solid var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .editor-pane, .preview-pane {
                width: 100%;
                height: 50%;
            }
            
            .resizer {
                width: 100%;
                height: 4px;
                cursor: row-resize;
                top: 50%;
                left: 0;
            }
            
            .toolbar {
                flex-wrap: wrap;
                padding: 4px 8px;
            }
            
            .toolbar-group {
                margin-bottom: 4px;
            }
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            background-color: var(--bg-primary);
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }

        .dropdown.active .dropdown-content {
            display: block;
        }

        .dropdown-item {
            color: var(--text-primary);
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background-color: var(--accent-color);
            color: white;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--success-color);
            color: white;
            padding: 12px 16px;
            border-radius: 6px;
            z-index: 1001;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.error {
            background-color: var(--error-color);
        }

        #mermaid-container svg {
            max-width: 100%;
            max-height: 100%;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 18px;
            font-weight: bold;
            margin: 0;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        .modal-body {
            margin-bottom: 16px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .file-input {
            display: none;
        }

        .paste-area {
            width: 100%;
            height: 200px;
            border: 2px dashed var(--border-color);
            border-radius: 6px;
            padding: 16px;
            margin-bottom: 16px;
            background-color: var(--bg-tertiary);
            color: var(--text-secondary);
            resize: none;
        }

        .paste-area:focus {
            outline: none;
            border-color: var(--accent-color);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-group">
                <div class="dropdown" id="examplesDropdown">
                    <button class="btn" id="examplesBtn">📋 Examples</button>
                    <div class="dropdown-content">
                        <div class="dropdown-item" data-type="flowchart">Flowchart</div>
                        <div class="dropdown-item" data-type="sequence">Sequence Diagram</div>
                        <div class="dropdown-item" data-type="gantt">Gantt Chart</div>
                        <div class="dropdown-item" data-type="class">Class Diagram</div>
                        <div class="dropdown-item" data-type="er">ER Diagram</div>
                        <div class="dropdown-item" data-type="state">State Diagram</div>
                        <div class="dropdown-item" data-type="pie">Pie Chart</div>
                    </div>
                </div>
            </div>

            <div class="toolbar-group">
                <button class="btn" id="themeToggle">🌙 Dark</button>
                <select class="select" id="mermaidTheme">
                    <option value="default">Default</option>
                    <option value="forest">Forest</option>
                    <option value="dark">Dark</option>
                    <option value="neutral">Neutral</option>
                    <option value="base">Base</option>
                </select>
            </div>

            <div class="toolbar-group">
                <button class="btn" id="exportPNG">📷 PNG</button>
                <button class="btn" id="exportSVG">🖼️ SVG</button>
                <button class="btn" id="exportPDF">📄 PDF</button>
            </div>

            <div class="toolbar-group">
                <button class="btn" id="copyCode">📋 Copy</button>
                <button class="btn" id="downloadCode">💾 Download</button>
                <button class="btn" id="clearEditor">🗑️ Clear</button>
            </div>

            <div class="toolbar-group">
                <button class="btn" id="uploadBtn">📤 Upload</button>
                <button class="btn" id="pasteBtn">📋 Paste</button>
                <button class="btn" id="fullscreenToggle">⛶ Fullscreen</button>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Editor Pane -->
            <div class="editor-pane" id="editorPane">
                <div class="editor-header">
                    <h3 style="margin: 0; font-size: 16px;">Mermaid Code Editor</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" id="renderBtn">▶️ Render</button>
                    </div>
                </div>
                <div class="editor-content">
                    <div id="editor"></div>
                </div>
            </div>

            <!-- Resizer -->
            <div class="resizer" id="resizer"></div>

            <!-- Preview Pane -->
            <div class="preview-pane" id="previewPane">
                <div class="preview-header">
                    <h3 style="margin: 0; font-size: 16px;">Diagram Preview</h3>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn" id="fitToScreen">📐 Fit</button>
                        <button class="btn" id="zoomIn">🔍+</button>
                        <button class="btn" id="zoomOut">🔍-</button>
                    </div>
                </div>
                <div class="preview-content">
                    <div id="preview">
                        <div class="loading">
                            <div class="spinner"></div>
                            Start typing Mermaid code to see the diagram...
                        </div>
                    </div>
                    <div class="zoom-controls" id="zoomControls">
                        <button class="zoom-btn" id="zoomInBtn">+</button>
                        <button class="zoom-btn" id="zoomOutBtn">-</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast"></div>

    <!-- Upload Modal -->
    <div class="modal" id="uploadModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload Mermaid File</h3>
                <button class="close-modal" id="closeUploadModal">&times;</button>
            </div>
            <div class="modal-body">
                <input type="file" id="fileInput" class="file-input" accept=".mmd,.txt,.md,.mermaid,.json">
                <label for="fileInput" class="btn" style="width: 100%; text-align: center; margin-bottom: 16px;">
                    📁 Select File
                </label>
                <p style="text-align: center; color: var(--text-secondary); margin-bottom: 16px;">
                    Supported formats: .mmd, .txt, .md, .mermaid
                </p>
                <div id="fileName" style="text-align: center; font-style: italic; color: var(--text-secondary);"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelUpload">Cancel</button>
                <button class="btn btn-primary" id="confirmUpload" disabled>Upload</button>
            </div>
        </div>
    </div>

    <!-- Paste Modal -->
    <div class="modal" id="pasteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Paste Mermaid Code</h3>
                <button class="close-modal" id="closePasteModal">&times;</button>
            </div>
            <div class="modal-body">
                <textarea id="pasteArea" class="paste-area" placeholder="Paste your Mermaid code here..."></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn" id="cancelPaste">Cancel</button>
                <button class="btn btn-primary" id="confirmPaste">Insert Code</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let editor;
        let currentTheme = 'light';
        let mermaidTheme = 'default';
        let currentScale = 1;
        let currentTranslateX = 0;
        let currentTranslateY = 0;
        let isFullscreen = false;
        let debounceTimer;
        let isDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;

        // Example diagrams
        const examples = {
            flowchart: `flowchart TD
    A[Christmas] -->|Get money| B(Go shopping)
    B --> C{Let me think}
    C -->|One| D[Laptop]
    C -->|Two| E[iPhone]
    C -->|Three| F[Car]`,

            sequence: `sequenceDiagram
    participant Alice
    participant Bob
    Alice->>John: Hello John, how are you?
    loop Healthcheck
        John->>John: Fight against hypochondria
    end
    Note right of John: Rational thoughts prevail!
    John-->>Alice: Great!
    John->>Bob: How about you?
    Bob-->>John: Jolly good!`,

            gantt: `gantt
    title A Gantt Diagram
    dateFormat  YYYY-MM-DD
    section Section
    A task           :a1, 2014-01-01, 30d
    Another task     :after a1  , 20d
    section Another
    Task in sec      :2014-01-12  , 12d
    another task     : 24d`,

            class: `classDiagram
    class Animal {
        +String name
        +int age
        +makeSound()
    }
    class Dog {
        +String breed
        +bark()
    }
    class Cat {
        +String color
        +meow()
    }
    Animal <|-- Dog
    Animal <|-- Cat`,

            er: `erDiagram
    CUSTOMER ||--o{ ORDER : places
    ORDER ||--|{ LINE-ITEM : contains
    CUSTOMER }|..|{ DELIVERY-ADDRESS : uses
    CUSTOMER {
        string name
        string custNumber
        string sector
    }
    ORDER {
        int orderNumber
        string deliveryAddress
    }
    LINE-ITEM {
        string productCode
        int quantity
        float pricePerUnit
    }`,

            state: `stateDiagram-v2
    [*] --> Still
    Still --> [*]
    Still --> Moving
    Moving --> Still
    Moving --> Crash
    Crash --> [*]`,

            pie: `pie title Pets adopted by volunteers
    "Dogs" : 386
    "Cats" : 85
    "Rats" : 15`
        };

        // Initialize application
        function init() {
            initializeMonacoEditor();
            initializeMermaid();
            setupEventListeners();
            setupResizer();
            setupModals();
        }

        // Initialize Monaco Editor
        function initializeMonacoEditor() {
            require.config({ paths: { vs: 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs' } });
            require(['vs/editor/editor.main'], function () {
                editor = monaco.editor.create(document.getElementById('editor'), {
                    value: examples.flowchart,
                    language: 'markdown',
                    theme: currentTheme === 'dark' ? 'vs-dark' : 'vs',
                    automaticLayout: true,
                    fontSize: 14,
                    wordWrap: 'on',
                    minimap: { enabled: false },
                    scrollBeyondLastLine: false,
                    tabSize: 2,
                    insertSpaces: true
                });

                // Auto-render on change
                editor.onDidChangeModelContent(() => {
                    debouncedRender();
                });

                // Initial render
                renderDiagram();
            });
        }

        // Initialize Mermaid
        function initializeMermaid() {
            mermaid.initialize({
                startOnLoad: false,
                theme: mermaidTheme,
                themeVariables: {
                    fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif'
                },
                flowchart: {
                    useMaxWidth: true,
                    htmlLabels: true
                },
                sequence: {
                    useMaxWidth: true
                },
                gantt: {
                    useMaxWidth: true
                }
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
            document.getElementById('mermaidTheme').addEventListener('change', (e) => {
                mermaidTheme = e.target.value;
                mermaid.initialize({ theme: mermaidTheme });
                renderDiagram();
            });

            document.getElementById('exportPNG').addEventListener('click', () => exportDiagram('png'));
            document.getElementById('exportSVG').addEventListener('click', () => exportDiagram('svg'));
            document.getElementById('exportPDF').addEventListener('click', () => exportDiagram('pdf'));

            document.getElementById('copyCode').addEventListener('click', copyCode);
            document.getElementById('downloadCode').addEventListener('click', downloadCode);
            document.getElementById('clearEditor').addEventListener('click', clearEditor);
            document.getElementById('fullscreenToggle').addEventListener('click', toggleFullscreen);
            document.getElementById('renderBtn').addEventListener('click', renderDiagram);

            document.getElementById('examplesBtn').addEventListener('click', toggleExamplesDropdown);
            document.getElementById('examplesDropdown').addEventListener('click', (e) => {
                if (e.target.dataset.type) {
                    loadExample(e.target.dataset.type);
                    closeExamplesDropdown();
                }
            });

            document.addEventListener('click', (e) => {
                const dropdown = document.getElementById('examplesDropdown');
                if (!dropdown.contains(e.target)) {
                    closeExamplesDropdown();
                }
            });

            document.getElementById('fitToScreen').addEventListener('click', fitToScreen);
            document.getElementById('zoomIn').addEventListener('click', () => zoom(1.2));
            document.getElementById('zoomOut').addEventListener('click', () => zoom(0.8));
            document.getElementById('zoomInBtn').addEventListener('click', () => zoom(1.2));
            document.getElementById('zoomOutBtn').addEventListener('click', () => zoom(0.8));

            document.addEventListener('fullscreenchange', handleFullscreenChange);
        }

        // Setup modal event listeners
        function setupModals() {
            // Upload modal
            document.getElementById('uploadBtn').addEventListener('click', () => {
                document.getElementById('uploadModal').style.display = 'flex';
            });

            document.getElementById('closeUploadModal').addEventListener('click', closeUploadModal);
            document.getElementById('cancelUpload').addEventListener('click', closeUploadModal);

            document.getElementById('fileInput').addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    document.getElementById('fileName').textContent = `Selected: ${file.name}`;
                    document.getElementById('confirmUpload').disabled = false;
                }
            });

            document.getElementById('confirmUpload').addEventListener('click', handleFileUpload);

            // Paste modal
            document.getElementById('pasteBtn').addEventListener('click', () => {
                document.getElementById('pasteModal').style.display = 'flex';
                document.getElementById('pasteArea').focus();
            });

            document.getElementById('closePasteModal').addEventListener('click', closePasteModal);
            document.getElementById('cancelPaste').addEventListener('click', closePasteModal);
            document.getElementById('confirmPaste').addEventListener('click', handlePaste);
        }

        function closeUploadModal() {
            document.getElementById('uploadModal').style.display = 'none';
            document.getElementById('fileInput').value = '';
            document.getElementById('fileName').textContent = '';
            document.getElementById('confirmUpload').disabled = true;
        }

        function closePasteModal() {
            document.getElementById('pasteModal').style.display = 'none';
            document.getElementById('pasteArea').value = '';
        }

        function toggleExamplesDropdown() {
            const dropdown = document.getElementById('examplesDropdown');
            dropdown.classList.toggle('active');
        }

        function closeExamplesDropdown() {
            const dropdown = document.getElementById('examplesDropdown');
            dropdown.classList.remove('active');
        }

        // Setup resizer
        function setupResizer() {
            const resizer = document.getElementById('resizer');
            const editorPane = document.getElementById('editorPane');
            const previewPane = document.getElementById('previewPane');
            const mainContent = document.querySelector('.main-content');
            
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.addEventListener('mousemove', handleResize);
                document.addEventListener('mouseup', stopResize);
                e.preventDefault();
            });

            function handleResize(e) {
                if (!isResizing) return;
                
                const containerRect = mainContent.getBoundingClientRect();
                const isMobile = window.innerWidth <= 768;
                
                if (isMobile) {
                    const percentage = ((e.clientY - containerRect.top) / containerRect.height) * 100;
                    if (percentage > 10 && percentage < 90) {
                        editorPane.style.height = `${percentage}%`;
                        previewPane.style.height = `${100 - percentage}%`;
                        resizer.style.top = `${percentage}%`;
                    }
                } else {
                    const percentage = ((e.clientX - containerRect.left) / containerRect.width) * 100;
                    if (percentage > 10 && percentage < 90) {
                        editorPane.style.width = `${percentage}%`;
                        previewPane.style.width = `${100 - percentage}%`;
                        resizer.style.left = `${percentage}%`;
                    }
                }
            }

            function stopResize() {
                isResizing = false;
                document.removeEventListener('mousemove', handleResize);
                document.removeEventListener('mouseup', stopResize);
            }
        }

        // Debounced render function
        function debouncedRender() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(renderDiagram, 500);
        }

        // Render diagram
        async function renderDiagram() {
            if (!editor) return;

            const code = editor.getValue().trim();
            const preview = document.getElementById('preview');
            
            if (!code) {
                preview.innerHTML = '<div class="loading">Enter Mermaid code to generate diagram...</div>';
                document.getElementById('zoomControls').style.display = 'none';
                return;
            }

            try {
                preview.innerHTML = '<div class="loading"><div class="spinner"></div>Rendering diagram...</div>';
                
                const { svg } = await mermaid.render('mermaid-svg-' + Date.now(), code);
                
                const container = document.createElement('div');
                container.id = 'mermaid-container';
                container.innerHTML = svg;
                
                preview.innerHTML = '';
                preview.appendChild(container);
                
                const svgElement = container.querySelector('svg');
                if (svgElement) {
                    setupCustomZoomPan(svgElement);
                    document.getElementById('zoomControls').style.display = 'flex';
                    setTimeout(() => fitSVGToScreen(svgElement), 100);
                }

            } catch (error) {
                preview.innerHTML = `
                    <div class="error-overlay">
                        <h3>Syntax Error</h3>
                        <p>${error.message}</p>
                        <small>Check your Mermaid syntax and try again</small>
                    </div>
                `;
                document.getElementById('zoomControls').style.display = 'none';
            }
        }

        // Custom zoom and pan implementation
        function setupCustomZoomPan(svgElement) {
            currentScale = 1;
            currentTranslateX = 0;
            currentTranslateY = 0;
            
            updateSVGTransform(svgElement);
            
            svgElement.addEventListener('mousedown', startPan);
            document.addEventListener('mousemove', pan);
            document.addEventListener('mouseup', endPan);
            
            svgElement.addEventListener('contextmenu', e => e.preventDefault());
        }

        function updateSVGTransform(svgElement) {
            if (svgElement) {
                svgElement.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale})`;
                svgElement.style.transformOrigin = 'center center';
            }
        }

        function startPan(e) {
            isDragging = true;
            dragStartX = e.clientX - currentTranslateX;
            dragStartY = e.clientY - currentTranslateY;
            e.preventDefault();
        }

        function pan(e) {
            if (isDragging) {
                currentTranslateX = e.clientX - dragStartX;
                currentTranslateY = e.clientY - dragStartY;
                const svgElement = document.querySelector('#mermaid-container svg');
                updateSVGTransform(svgElement);
            }
        }

        function endPan() {
            isDragging = false;
        }

        function fitSVGToScreen(svgElement) {
            if (!svgElement) return;
            
            const container = document.getElementById('preview');
            const containerRect = container.getBoundingClientRect();
            const svgRect = svgElement.getBBox();
            
            if (svgRect.width === 0 || svgRect.height === 0) return;
            
            const scaleX = (containerRect.width - 40) / svgRect.width;
            const scaleY = (containerRect.height - 40) / svgRect.height;
            
            currentScale = Math.min(scaleX, scaleY, 1);
            currentTranslateX = 0;
            currentTranslateY = 0;
            
            updateSVGTransform(svgElement);
        }

        // Theme toggle
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            
            const toggleBtn = document.getElementById('themeToggle');
            toggleBtn.textContent = currentTheme === 'dark' ? '☀️ Light' : '🌙 Dark';
            
            if (editor) {
                monaco.editor.setTheme(currentTheme === 'dark' ? 'vs-dark' : 'vs');
            }
        }

        // Load example
        function loadExample(type) {
            if (examples[type] && editor) {
                editor.setValue(examples[type]);
                showToast(`Loaded ${type} example`);
            }
        }

        // Copy code to clipboard
        async function copyCode() {
            if (!editor) return;
            
            try {
                await navigator.clipboard.writeText(editor.getValue());
                showToast('Code copied to clipboard!');
            } catch (err) {
                showToast('Failed to copy code', 'error');
            }
        }

        // Download code as file
        function downloadCode() {
            if (!editor) return;
            
            const code = editor.getValue();
            if (!code.trim()) {
                showToast('No code to download', 'error');
                return;
            }
            
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mermaid-diagram-${new Date().toISOString().slice(0, 10)}.mmd`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Code downloaded!');
        }

        // Clear editor
        function clearEditor() {
            if (editor && confirm('Clear all code?')) {
                editor.setValue('');
                showToast('Editor cleared');
            }
        }

        // Handle file upload
        function handleFileUpload() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showToast('No file selected', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const content = e.target.result;
                    if (editor) {
                        editor.setValue(content);
                        showToast('File loaded successfully!');
                        closeUploadModal();
                    }
                } catch (err) {
                    showToast('Error reading file', 'error');
                    console.error(err);
                }
            };
            reader.onerror = () => {
                showToast('Error reading file', 'error');
            };
            reader.readAsText(file);
        }

        // Handle paste from modal
        function handlePaste() {
            const pasteArea = document.getElementById('pasteArea');
            const code = pasteArea.value.trim();
            
            if (!code) {
                showToast('No code to paste', 'error');
                return;
            }
            
            if (editor) {
                editor.setValue(code);
                showToast('Code pasted successfully!');
                closePasteModal();
            }
        }

        // Export functions
        function exportDiagram(format) {
            const container = document.getElementById('mermaid-container');
            if (!container) {
                showToast('No diagram to export', 'error');
                return;
            }

            const filename = `mermaid-diagram-${new Date().toISOString().slice(0, 10)}`;

            switch (format) {
                case 'svg':
                    exportSVG(container, filename);
                    break;
                case 'png':
                    exportPNG(container, filename);
                    break;
                case 'pdf':
                    exportPDF(container, filename);
                    break;
            }
        }

        function exportSVG(container, filename) {
            const svg = container.querySelector('svg');
            if (!svg) return;

            const svgData = new XMLSerializer().serializeToString(svg);
            const blob = new Blob([svgData], { type: 'image/svg+xml' });
            downloadBlob(blob, `${filename}.svg`);
            showToast('SVG exported successfully!');
        }

        function exportPNG(container, filename) {
            const svg = container.querySelector('svg');
            if (!svg) return;

            // Get the actual dimensions of the SVG content
            const bbox = svg.getBBox();
            const width = bbox.width + bbox.x * 2;
            const height = bbox.height + bbox.y * 2;

            // Create a canvas for high-quality rendering
            const canvas = document.createElement('canvas');
            const scale = 4; // High DPI scaling factor
            canvas.width = width * scale;
            canvas.height = height * scale;
            canvas.style.width = `${width}px`;
            canvas.style.height = `${height}px`;
            
            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);

            // Serialize SVG to data URL
            const svgData = new XMLSerializer().serializeToString(svg);
            const img = new Image();
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(svgBlob);

            img.onload = function() {
                // Draw the SVG image to canvas
                ctx.drawImage(img, 0, 0, width, height);
                URL.revokeObjectURL(url);

                // Convert canvas to PNG
                canvas.toBlob(function(blob) {
                    const pngUrl = URL.createObjectURL(blob);
                    const downloadLink = document.createElement('a');
                    downloadLink.href = pngUrl;
                    downloadLink.download = `${filename}.png`;
                    document.body.appendChild(downloadLink);
                    downloadLink.click();
                    document.body.removeChild(downloadLink);
                    setTimeout(() => URL.revokeObjectURL(pngUrl), 100);
                    showToast('High-quality PNG exported successfully!');
                }, 'image/png', 1.0);
            };

            img.src = url;
        }

        function exportPDF(container, filename) {
            const svg = container.querySelector('svg');
            if (!svg) return;

            // Get the actual dimensions of the SVG content
            const bbox = svg.getBBox();
            const width = bbox.width + bbox.x * 2;
            const height = bbox.height + bbox.y * 2;

            // Create a canvas for high-quality rendering
            const canvas = document.createElement('canvas');
            const scale = 2; // High DPI scaling factor for PDF
            canvas.width = width * scale;
            canvas.height = height * scale;
            canvas.style.width = `${width}px`;
            canvas.style.height = `${height}px`;
            
            const ctx = canvas.getContext('2d');
            ctx.scale(scale, scale);

            // Serialize SVG to data URL
            const svgData = new XMLSerializer().serializeToString(svg);
            const img = new Image();
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(svgBlob);

            img.onload = function() {
                // Draw the SVG image to canvas
                ctx.drawImage(img, 0, 0, width, height);
                URL.revokeObjectURL(url);

                // Convert canvas to PNG data URL
                const pngDataUrl = canvas.toDataURL('image/png', 1.0);
                
                // Create PDF
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: width > height ? 'landscape' : 'portrait',
                    unit: 'mm'
                });

                // Calculate dimensions to fit PDF page (A4 size)
                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                
                // Maintain aspect ratio
                const imgWidth = pageWidth - 20; // 10mm margins on each side
                const imgHeight = (height * imgWidth) / width;
                
                // Add image to PDF
                pdf.addImage(pngDataUrl, 'PNG', 
                    (pageWidth - imgWidth) / 2, // Center horizontally
                    (pageHeight - imgHeight) / 2, // Center vertically
                    imgWidth, 
                    imgHeight
                );
                
                pdf.save(`${filename}.pdf`);
                showToast('High-quality PDF exported successfully!');
            };

            img.src = url;
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Zoom functions
        function zoom(factor) {
            const svgElement = document.querySelector('#mermaid-container svg');
            if (!svgElement) return;

            const prevScale = currentScale;
            currentScale = Math.max(0.1, Math.min(10, currentScale * factor));
            
            updateSVGTransform(svgElement);
        }

        function fitToScreen() {
            const svgElement = document.querySelector('#mermaid-container svg');
            if (svgElement) {
                fitSVGToScreen(svgElement);
                showToast('Diagram fitted to screen');
            }
        }

        // Fullscreen functions
        function toggleFullscreen() {
            const previewPane = document.getElementById('previewPane');
            
            if (!isFullscreen) {
                if (previewPane.requestFullscreen) {
                    previewPane.requestFullscreen();
                } else if (previewPane.webkitRequestFullscreen) {
                    previewPane.webkitRequestFullscreen();
                } else if (previewPane.msRequestFullscreen) {
                    previewPane.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        function handleFullscreenChange() {
            isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
            const toggleBtn = document.getElementById('fullscreenToggle');
            toggleBtn.textContent = isFullscreen ? '⛶ Exit' : '⛶ Fullscreen';
            
            if (isFullscreen) {
                document.getElementById('previewPane').classList.add('fullscreen');
            } else {
                document.getElementById('previewPane').classList.remove('fullscreen');
            }
        }

        // Toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.className = toast.className.replace('show', '');
            }, 3000);
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            if (editor) {
                editor.layout();
            }
            setTimeout(() => {
                const svgElement = document.querySelector('#mermaid-container svg');
                if (svgElement) {
                    fitSVGToScreen(svgElement);
                }
            }, 100);
        });

        // Handle wheel event for zoom
        document.getElementById('preview').addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? 0.9 : 1.1;
                zoom(delta);
            }
        });

        // Touch support for mobile
        let lastTouchDistance = 0;
        let touchStartTranslateX = 0;
        let touchStartTranslateY = 0;
        
        document.getElementById('preview').addEventListener('touchstart', (e) => {
            if (e.touches.length === 2) {
                lastTouchDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
            } else if (e.touches.length === 1) {
                touchStartTranslateX = currentTranslateX;
                touchStartTranslateY = currentTranslateY;
                dragStartX = e.touches[0].clientX;
                dragStartY = e.touches[0].clientY;
                isDragging = true;
            }
        });

        document.getElementById('preview').addEventListener('touchmove', (e) => {
            e.preventDefault();
            
            if (e.touches.length === 2) {
                const currentDistance = Math.hypot(
                    e.touches[0].pageX - e.touches[1].pageX,
                    e.touches[0].pageY - e.touches[1].pageY
                );
                
                if (lastTouchDistance > 0) {
                    const ratio = currentDistance / lastTouchDistance;
                    zoom(ratio);
                }
                
                lastTouchDistance = currentDistance;
            } else if (e.touches.length === 1 && isDragging) {
                const deltaX = e.touches[0].clientX - dragStartX;
                const deltaY = e.touches[0].clientY - dragStartY;
                
                currentTranslateX = touchStartTranslateX + deltaX;
                currentTranslateY = touchStartTranslateY + deltaY;
                
                const svgElement = document.querySelector('#mermaid-container svg');
                updateSVGTransform(svgElement);
            }
        });

        document.getElementById('preview').addEventListener('touchend', () => {
            isDragging = false;
            lastTouchDistance = 0;
        });

        // Error handling
        window.addEventListener('error', (e) => {
            console.error('Application error:', e.error);
            showToast('An error occurred. Check console for details.', 'error');
        });

        // Initialize when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }

        console.log('🎨 Mermaid Diagram Viewer initialized successfully!');
    </script>
</body>
</html>
